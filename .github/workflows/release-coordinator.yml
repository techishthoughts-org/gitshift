---
name: ðŸš€ Release Coordinator
on:
  # Trigger on successful CI completion
  workflow_run:
    workflows: [ðŸš€ GitShift CI]
    types: [completed]
    branches: [main]
jobs:
  # ðŸŽ¯ Coordinate Release Process
  coordinate-release:
    name: ðŸŽ¯ Coordinate Release Process
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch
      == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: ðŸ” Check for New Commits
        id: check
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Check if there are new commits since last tag
          NEW_COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline | wc -l)
          echo "New commits since last tag: $NEW_COMMITS"
          if [ "$NEW_COMMITS" -gt 0 ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "âœ… New commits found - release will be triggered"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new commits - skipping release"
          fi
      - name: ðŸš€ Trigger Release Process
        if: steps.check.outputs.should_release == 'true'
        run: |
          echo "ðŸŽ¯ Triggering release process..."
          echo "ðŸ“‹ This will:"
          echo "   1. Create a new version tag"
          echo "   2. Build multi-platform binaries"
          echo "   3. Publish GitHub release"
          echo ""
          echo "ðŸ”„ The release-tag.yml workflow will handle the rest automatically"
      - name: ðŸ“Š Release Status
        run: |-
          if [ "${{ steps.check.outputs.should_release }}" = "true" ]; then
            echo "## ðŸŽ¯ Release Coordination Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Status**: Release process triggered" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Next Steps**: The release-tag.yml workflow will create the tag" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ—ï¸ **Build**: release-build.yml will build binaries" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Publish**: release-publish.yml will create the GitHub release" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸŽ¯ Release Coordination Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **Status**: No release needed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Reason**: No new commits since last tag" >> $GITHUB_STEP_SUMMARY
          fi
